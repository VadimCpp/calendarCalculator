<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
</head>
<body>
    <header class="container-fluid py-5 bg-dark text-white">
        <h1 class="text-center">–ö–∞–ª–µ–Ω–¥–∞—Ä—å-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
    </header>
    <section class="container py-4">
        <h2> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–º </h2>
        <p> <b> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å </b> <span id="user-name"> ... </span> </p>
        <hr>
        <p>
            <button id="authorize-btn" class="button rounded py-2 px-3" disabled="true">–í–æ–π—Ç–∏</button>
            <button id="signout-btn" class="button rounded py-2 px-3" disabled="true">–í—ã–π—Ç–∏</button>
        </p>
    </section>
    <section id="calendars-panel" style="display:none;" class="container py-4">        
        <h2> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è–º–∏ </h2>
        <p>
            <b> –ö–∞–ª–µ–Ω–¥–∞—Ä–∏ </b> <br> <span id="calendars-list"> –ø—É—Å—Ç–æ </span>
        </p>
        <hr>
        <p>
            <button id="list-calendars-btn" class="button rounded py-2 px-3">–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π</button>            
        </p>
        <p> <b> –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—å: </b> </p>
        <ul id="calendars-radio-list" class="list-group">

        </ul>
    </section>
    <section id="events-panel" style="display:none;" class="container py-4">
        <h2> –°–æ–±—ã—Ç–∏—è –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ </h2>
        <p>
            <b> –°–æ–±—ã—Ç–∏—è </b> <span id="events-list"> –ø—É—Å—Ç–æ </span>
        </p>
        <hr>
        <p>
            <button id="list-events-btn" class="button rounded py-2 px-3">–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π</button>            
        </p>        
    </section>
    <section id="calculator-panel" style="display:none;" class="container py-4">
        <h2> –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–∞–Ω–Ω—ã—Ö </h2>
        <p id="calculation">
            ...
        </p>
        <p>
            <button id="calculate-btn" class="button rounded py-2 px-3">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –µ—â–µ —Ä–∞–∑</button>            
        </p>        
    </section>

    <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script>
        /**
         * Global app variables.
         */
        var globals = {
            calendarsList: null
        };

        function start() {
            /**
             * Init the client first.
             * Then init the model and update UI.
             */
            gapi.client.init({
                'apiKey': 'AIzaSyA-udSmPEWrf2gzxZeqV-dfBLrYnT1Cd5I',
                'clientId': '432393497287-9i1o458ibu2lk00h6h9el7mimhkd8dvq.apps.googleusercontent.com',
                'scope': 'profile https://www.googleapis.com/auth/calendar.readonly',

            }).then(function() {

                gapi.auth2.getAuthInstance().isSignedIn.listen(signinStatusEvent);

                updateAuthButtonPanel();
                updateUserName();
                updateCalendarsPanel();
                updateCalendarsList();
                updateEventsPanel();
                updateCalculatorPanel();
                updateCalculation();                

                $('#authorize-btn').click(function() {                
                    gapi.auth2.getAuthInstance().signIn();                                    
                });

                $('#signout-btn').click(function() {                
                    gapi.auth2.getAuthInstance().signOut();
                });
              
                $('#list-calendars-btn').click(function() {
                    updateCalendarsList();
                });

                $('#list-events-btn').click(function() {
                    updateEventsList();
                });

                $('#calculate-btn').click(function() {
                    updateCalculation();
                });
            });

            /**
             * Handler.
             * Listen to auth status beeing changed.
             */
            function signinStatusEvent(isSignedIn) {
                updateAuthButtonPanel();
                updateUserName();
                updateCalendarsPanel();   
                updateCalendarsList();
                updateCalendarsRadioList();
                updateEventsPanel();
                updateEventsList();
                updateCalculatorPanel();
                updateCalculation();
            }

            /**
             * UI method.
             * Updates auth button panel.
             */
            function updateAuthButtonPanel() {
                if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
                    $("#authorize-btn").prop('disabled', true);
                    $("#signout-btn").prop('disabled', false);                    
                } else {
                    $("#authorize-btn").prop('disabled', false);
                    $("#signout-btn").prop('disabled', true);
                }
            }

            /**
             * UI method.
             * Updates user name.
             */
            function updateUserName() {
                gapi.client.request({
                    'path': 'https://people.googleapis.com/v1/people/me?requestMask.includeField=person.names',
                }).then(function(response) {
                    $("#user-name").text(
                        response.result.names && response.result.names[0] && response.result.names[0].displayName ? 
                        response.result.names[0].displayName : 
                        '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚òπÔ∏è'
                    );
                }, function(reason) {
                    console.log('Error: ' + reason && reason.result && reason.result.error && reason.result.error.message ? reason.result.error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    $("#user-name").text('–ê–Ω–æ–Ω üòé');
                });
            }

            /**
             * UI method.
             * Updates user name.
             */
            function updateCalendarsPanel() {
                if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
                    $("#calendars-panel").show();                    
                } else {
                    $("#calendars-panel").hide();
                }
            }

            /**
             * UI method.
             * Updates list of calendars.
             */  
            function updateCalendarsList(success, data) {

                $('#calendars-list').text('...');
                
                globals.calendarsList = null;
                updateCalendarsRadioList();

                gapi.client.request({
                    'path': 'https://www.googleapis.com/calendar/v3/users/me/calendarList',
                }).then(function(response) {

                    if (response && response.result && response.result.items && response.result.items.length) {
                        globals.calendarsList = response.result.items;
                        var text = '';

                        for (var i = 0; i < response.result.items.length; i++) {
                            text += response.result.items[i].summary;
                            if (i < response.result.items.length - 1) {
                                text += ", ";
                            }
                        }
                        
                        $('#calendars-list').text(text);
                    } else {
                        $('#calendars-list').text('–ø—É—Å—Ç–æ');
                    }
                    
                    updateCalendarsRadioList();

                }, function(reason) {
                    $('#calendars-list').text('–ø—É—Å—Ç–æ');
                    updateCalendarsRadioList();
                });
            }

            /**
             * UI method.
             * Updates list of calendars.
             */  
            function updateCalendarsRadioList() {

                if (globals.calendarsList) {
                    var text = '';

                    for (var i = 0; i < globals.calendarsList.length; i++) {
                        text += 
                            '<li class="list-group-item">' +
                            '<input type="radio" value="' + globals.calendarsList[i].id + '" name="calendars-group">' +
                            ' <label for="' + globals.calendarsList[i].id + '">' + globals.calendarsList[i].summary + '</label>' +
                            '</li>';                              
                    }
                    
                    $('#calendars-radio-list').html(text);

                    $('input[type=radio][name=calendars-group]').on('change', function() {
                        updateEventsPanel();
                        updateEventsList();
                        updateCalculatorPanel();
                        updateCalculation();
                    });
                } else {
                    $('#calendars-radio-list').html('');
                }
            }

            /**
             * UI method.
             * Updates visibility of events panel.
             */
            function updateEventsPanel() {
                if ($('input[name=calendars-group]:checked').val()) {
                    $("#events-panel").show();                    
                } else {
                    $("#events-panel").hide();
                }
            }

            /**
             * UI method.
             * Updates list of events.
             */  
            function updateEventsList() {
                var calendarId = $('input[name=calendars-group]:checked').val();
                
                $('#events-list').html('...');

                if ($('input[name=calendars-group]:checked').val()) {

                    var beginningOfCurrentYear = moment((new Date(new Date().getFullYear(), 0, 1)).getTime()).format();

                    gapi.client.request({
                        'path': 'https://www.googleapis.com/calendar/v3/calendars/' + calendarId + '/events' + 
                                '?timeMin=' + encodeURIComponent(beginningOfCurrentYear),
                    }).then(function(response) {

                        if (response && response.result && response.result.items) {
                            var total = '' + response.result.items.length + ' –∑–∞–ø–∏—Å—å(–µ–π)<br>';
                            var text = total;
                            for (var i = 0; i < response.result.items.length; i++) {
                                text += response.result.items[i].summary + ' : ' + response.result.items[i].description
                                text += '<br>';
                            }
                            $('#events-list').html(text);
                        } else {
                            $('#events-list').html('–ø—É—Å—Ç–æ');
                        }

                    }, function(reason) {
                        $('#events-list').html('–ø—É—Å—Ç–æ');
                    });

                } else {
                    $('#events-list').html('–ø—É—Å—Ç–æ');
                }
            };

            /**
             * UI method.
             * Updates visibility of events panel.
             */
            function updateCalculatorPanel() {
                if ($('input[name=calendars-group]:checked').val()) {
                    $("#calculator-panel").show();                    
                } else {
                    $("#calculator-panel").hide();
                }
            }

            /**
             * UI method.
             * Updates calculation.
             */  
            function updateCalculation() {
                console.log('updateCalculation');

                var calendarId = $('input[name=calendars-group]:checked').val();
                
                $('#calculation').html('...');

                if ($('input[name=calendars-group]:checked').val()) {

                    var beginningOfCurrentYear = moment((new Date(new Date().getFullYear(), 0, 1)).getTime()).format();

                    gapi.client.request({
                        'path': 'https://www.googleapis.com/calendar/v3/calendars/' + calendarId + '/events' + 
                                '?timeMin=' + encodeURIComponent(beginningOfCurrentYear),
                    }).then(function(response) {

                        if (response && response.result && response.result.items) {                            
                            var text = '–ü–æ –º–µ—Å—è—Ü–∞–º:<br>';
                            var month = '';
                            var total = 0;
                            for (var i = 0; i < response.result.items.length; i++) {

                                var item = response.result.items[i];
                                var itemMonth = (moment(item.start.dateTime).month());
                                if (month != itemMonth) {
                                    if (month) {
                                        text += '–ò—Ç–æ–≥–æ: ' + total;
                                        text += '<br>';
                                        total = 0;
                                    }

                                    text += '–ú–µ—Å—è—Ü ' + itemMonth + '<br>' ;
                                    month = itemMonth;
                                }
                                total += isNaN(parseInt(item.summary)) ? 0 : parseInt(item.summary);
                                text += ' + ' + item.summary;
                                text += '<br>';
                            }
                            text += '–ò—Ç–æ–≥–æ: ' + total;
                            text += '<br>';
                            $('#calculation').html(text);
                        } else {
                            $('#calculation').html('–ø—É—Å—Ç–æ');
                        }

                    }, function(reason) {
                        $('#calculation').html('–ø—É—Å—Ç–æ');
                    });

                } else {
                    $('#calculation').html('–ø—É—Å—Ç–æ');
                }
            }

        };

        gapi.load('client', start);
    </script>
</body>
</html>
