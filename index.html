<!DOCTYPE html>
<html>
<head>
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
</head>
<body>
    <header class="container-fluid py-5 bg-dark text-white">
        <h1 class="text-center">–ö–∞–ª–µ–Ω–¥–∞—Ä—å-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</h1>
    </header>
    <section class="container py-4">
        <h2> –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–º </h2>
        <p> <b> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å </b> <span id="user-name"> ... </span> </p>
        <hr>
        <p>
            <button id="authorize-btn" class="button rounded py-2 px-3" disabled="true">–í–æ–π—Ç–∏</button>
            <button id="signout-btn" class="button rounded py-2 px-3" disabled="true">–í—ã–π—Ç–∏</button>
        </p>
    </section>
    <section id="calendars-panel" style="display:none;" class="container py-4">
        <h2> –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è–º–∏ </h2>
        <p>
            <b> –ö–∞–ª–µ–Ω–¥–∞—Ä–∏ </b> <span id="calendars-list"> –ø—É—Å—Ç–æ </span>
        </p>
        <hr>
        <p>
            <button id="list-calendars-btn" class="button rounded py-2 px-3">–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π</button>            
        </p>        
    </section>

    <script
        src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>

        function start() {
            /**
             * Init the client first.
             * Then init the model and update UI.
             */
            gapi.client.init({
                'apiKey': 'AIzaSyA-udSmPEWrf2gzxZeqV-dfBLrYnT1Cd5I',
                'clientId': '432393497287-9i1o458ibu2lk00h6h9el7mimhkd8dvq.apps.googleusercontent.com',
                'scope': 'profile https://www.googleapis.com/auth/calendar.readonly',

            }).then(function() {

                gapi.auth2.getAuthInstance().isSignedIn.listen(signinStatusEvent);

                updateAuthButtonPanel();
                updateUserName();
                updateCalendarsPanel();
                updateCalendarsList(); 

                $('#authorize-btn').click(function() {                
                    gapi.auth2.getAuthInstance().signIn();                                    
                });

                $('#signout-btn').click(function() {                
                    gapi.auth2.getAuthInstance().signOut();
                });
              
                $('#list-calendars-btn').click(function() {
                    updateCalendarsList();
                });
            });

            /**
             * Handler.
             * Listen to auth status beeing changed.
             */
            function signinStatusEvent(isSignedIn) {
                updateAuthButtonPanel();
                updateUserName();
                updateCalendarsPanel();   
                updateCalendarsList();             
            }

            /**
             * UI method.
             * Updates auth button panel.
             */
            function updateAuthButtonPanel() {
                if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
                    $("#authorize-btn").prop('disabled', true);
                    $("#signout-btn").prop('disabled', false);                    
                } else {
                    $("#authorize-btn").prop('disabled', false);
                    $("#signout-btn").prop('disabled', true);
                }
            }

            /**
             * UI method.
             * Updates user name.
             */
            function updateUserName() {
                gapi.client.request({
                    'path': 'https://people.googleapis.com/v1/people/me?requestMask.includeField=person.names',
                }).then(function(response) {
                    $("#user-name").text(
                        response.result.names && response.result.names[0] && response.result.names[0].displayName ? 
                        response.result.names[0].displayName : 
                        '–ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚òπÔ∏è'
                    );
                }, function(reason) {
                    console.log('Error: ' + reason && reason.result && reason.result.error && reason.result.error.message ? reason.result.error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    $("#user-name").text('–ê–Ω–æ–Ω üòé');
                });
            }

            /**
             * UI method.
             * Updates user name.
             */
            function updateCalendarsPanel() {
                if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
                    $("#calendars-panel").show();                    
                } else {
                    $("#calendars-panel").hide();
                }
            }

            /**
             * UI method.
             * Updates list of calendars.
             */  
            function updateCalendarsList(success, data) {

                $('#calendars-list').text('...');

                gapi.client.request({
                    'path': 'https://www.googleapis.com/calendar/v3/users/me/calendarList',
                }).then(function(response) {
                    console.log('OK', response);
                    if (response && response.result && response.result.items && response.result.items.length) {
                        var text = '';

                        for (var i = 0; i < response.result.items.length; i++) {
                            text += response.result.items[i].summary;
                            if (i < response.result.items.length - 1) {
                                text += ", ";
                            }
                        }
                        
                        $('#calendars-list').text(text);
                    } else {
                        $('#calendars-list').text('–ø—É—Å—Ç–æ');
                    }
                    
                }, function(reason) {
                    $('#calendars-list').text('–ø—É—Å—Ç–æ');
                });
            }
        };

        gapi.load('client', start);
    </script>
</body>
</html>
